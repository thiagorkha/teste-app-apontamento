<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1D4ED8"> <!-- Cor primária nova -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Produção | Foco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Cores atualizadas para um visual mais moderno e profissional */
        :root {
            --primary: #1D4ED8; /* Azul Escuro */
            --secondary: #059669; /* Verde Industrial */
            --background: #f7f9fc; /* Fundo muito claro */
            --card: #ffffff; /* Cartão branco */
            --text-color: #1f2937; /* Texto escuro */
            --border-color: #e5e7eb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-color);
        }
        .container-app {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .card {
            background-color: var(--card);
            padding: 2rem;
            border-radius: 1.25rem; /* Mais arredondado */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05); /* Sombra mais profunda */
            border: 1px solid var(--border-color); /* Borda sutil */
            width: 100%;
            max-width: 420px;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem; /* Mais arredondado */
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            margin-top: 0.5rem;
            background-color: #f9fafb; /* Fundo levemente cinza */
        }
        .input-field:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.2);
            background-color: var(--card);
        }
        .btn-base {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            /* width: 100%; <- Removido para os botões do Passo 2 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-base:active {
            transform: translateY(1px);
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: #1E40AF;
        }
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        .btn-secondary:hover {
            background-color: #047857;
        }
        .summary-info-block {
            background-color: #f3f4f6; /* Fundo cinza suave */
            padding: 1rem;
            border-radius: 0.75rem;
            border-left: 4px solid var(--primary);
        }
        .timer-display-area {
            background-color: var(--text-color); /* Fundo escuro para contraste */
            color: #10B981; /* Verde neon para o timer */
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            font-size: 2.5rem; /* Maior */
            letter-spacing: 2px;
            font-family: monospace;
        }
        /* Style for restore banner */
        .restore-banner {
            background-color: #fffbeb;
            border: 2px solid #f59e0b;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>

<div class="container-app">
    <div class="card">
        <h1 id="app-title" class="text-3xl font-extrabold mb-8 text-center text-gray-900 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7 mr-2 text-primary">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
            Foco Produção
        </h1>

        <!-- Banner de Restauração -->
        <div id="restore-banner" class="restore-banner hidden">
            <p class="text-sm font-bold text-amber-800 mb-2 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1 text-amber-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.021 3.375 1.767 3.375h14.468c1.745 0 2.632-1.875 1.767-3.375L13.5 7.5c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                </svg>
                Sessão em Andamento
            </p>
            <p class="text-xs text-amber-700 mb-4">Continuar a produção anterior ou iniciar um novo registro?</p>
            <div class="flex gap-3">
                <button onclick="restoreSession()" class="btn-secondary text-sm py-2">Continuar</button>
                <button onclick="discardSession()" class="btn-primary text-sm py-2 opacity-80 bg-red-600 hover:bg-red-700">Descartar</button>
            </div>
        </div>

        <div id="message-box" class="hidden p-3 mb-4 rounded-xl text-center text-sm font-medium border" role="alert"></div>

        <!-- Passo 1: Informações Básicas -->
        <div id="step-1" class="step">
            <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">Identificação</h2>
            
            <div class="mb-5">
                <label for="operador" class="block text-sm font-medium text-gray-700">Nome do Operador</label>
                <input type="text" id="operador" class="input-field" placeholder="Ex: João Silva" required>
                <!-- Opção para salvar o nome do operador -->
                <div class="flex items-center mt-2">
                    <input id="saveOperador" type="checkbox" class="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary">
                    <label for="saveOperador" class="ml-2 block text-sm text-gray-600">Lembrar Operador</label>
                </div>
            </div>

            <div class="mb-8">
                <label for="maquina" class="block text-sm font-medium text-gray-700">Máquina / Linha</label>
                <select id="maquina" class="input-field">
                    <option value="">Selecione...</option>
                    <option>Romi D1000</option>
                    <option>Veker Mvk 1050</option>
                    <option>Torno Cnc Cosmos</option>
                    <option>Torno Convencional</option>
                    <option>Torno Mascote</option>
                    <option>Fresadora Ferramenteira</option>
                </select>
                <!-- Opção para salvar a máquina -->
                <div class="flex items-center mt-2">
                    <input id="saveMaquina" type="checkbox" class="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary">
                    <label for="saveMaquina" class="ml-2 block text-sm text-gray-600">Lembrar Máquina</label>
                </div>
            </div>

            <button onclick="nextStep(1)" class="btn-base btn-primary w-full">Prosseguir</button>
        </div>

        <!-- Passo 2: Informações da Ordem de Produção -->
        <div id="step-2" class="step hidden">
            <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">Detalhes da Produção</h2>
            <div class="mb-5">
                <label for="op" class="block text-sm font-medium text-gray-700">Ordem de Produção (OP)</label>
                <input type="text" id="op" class="input-field" placeholder="Ex: 2024-12345" required>
            </div>
            <div class="mb-8">
                <label for="cp" class="block text-sm font-medium text-gray-700">Código do Produto (CP)</label>
                <input type="text" id="cp" class="input-field" placeholder="Ex: PROD-A01" required>
            </div>
            
            <div class="flex space-x-3 mb-3">
                <!-- NOVO Botão para iniciar o Setup -->
                <button onclick="startSetup()" class="btn-base btn-secondary flex-1">
                    <div class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.061.366.33.682.644.864l1.12.68c.456.276.66.812.52 1.328l-.297.94c-.09.286-.412.443-.64.443-.09 0-.17-.02-.25-.05l-1.11-.64c-.354-.203-.76-.363-1.192-.47l-.282-.07c-.438-.112-.9-.112-1.338 0l-.282.07c-.43.107-.837.267-1.19.47l-1.11.64c-.228.13-.55.286-.64.443l-.297-.94c-.14-.516.064-1.052.52-1.328l1.12-.68c.314-.182.583-.498.644-.864l.213-1.281Z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        Iniciar Setup
                    </div>
                </button>
                
                <!-- Botão para iniciar a Produção diretamente -->
                <button onclick="startProduction()" class="btn-base btn-primary flex-1">
                    <div class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m-4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        Iniciar Produção
                    </div>
                </button>
            </div>
            
            <button onclick="prevStep(2)" class="btn-base btn-primary mt-3 opacity-75 bg-gray-400 hover:bg-gray-500 w-full">Voltar</button>
        </div>

        <!-- Passo 3: Cronômetro de Produção -->
        <div id="step-3" class="step hidden">
            <!-- Título ajustado dinamicamente -->
            <h2 id="step-3-title" class="text-xl font-semibold mb-6 text-center text-gray-700">...</h2>
            
            <!-- Resumo de informações acima do cronômetro (Design melhorado) -->
            <div id="step-3-summary" class="summary-info-block mb-6 grid grid-cols-2 gap-3 text-sm">
                <div>
                    <strong class="text-gray-500 font-medium">Operador</strong>
                    <span id="info-operador" class="block font-semibold text-gray-800">N/A</span>
                </div>
                <div>
                    <strong class="text-gray-500 font-medium">Máquina</strong>
                    <span id="info-maquina" class="block font-semibold text-gray-800">N/A</span>
                </div>
                <div class="col-span-2">
                    <strong class="text-gray-500 font-medium">OP / Produto</strong>
                    <span id="info-op-cp" class="block font-semibold text-gray-800">N/A / N/A</span>
                </div>
            </div>

            <div class="text-center mb-8 timer-display-area">
                <p class="font-bold" id="timer-display">00:00:00</p>
                <p id="timer-status" class="text-xs text-gray-400 mt-2 tracking-normal">Tempo Decorrido</p>
            </div>
            
            <!-- Botões Dinâmicos para Setup e Produção -->
            <!-- Botão: Finalizar Setup e Iniciar Produção -->
            <button id="btn-finish-setup" onclick="finishSetup()" class="btn-base btn-secondary w-full">
                <div class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    Finalizar Setup e Iniciar Produção
                </div>
            </button>
            
            <!-- Botão: Finalizar e Registrar (Produção) -->
            <button id="btn-finish-production" onclick="finishProduction()" class="btn-base btn-primary bg-red-600 hover:bg-red-700 w-full hidden">
                <div class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    Finalizar e Registrar
                </div>
            </button>
        </div>

        <!-- Passo 4: Resumo e Dados Finais -->
        <div id="step-4" class="step hidden">
            <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">Dados Finais</h2>

            <div class="space-y-3 p-4 mb-6 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                <div class="flex justify-between">
                    <strong class="text-gray-500">Duração Total Produção:</strong><span id="summary-duration" class="font-semibold text-secondary">00:00:00</span>
                </div>
                <!-- Exibição do Tempo de Setup (NOVO) -->
                <div class="flex justify-between">
                    <strong class="text-gray-500">Duração Setup:</strong><span id="summary-setup-time" class="font-semibold text-primary">00:00:00</span>
                </div>
                <div class="flex justify-between">
                    <strong class="text-gray-500">Operador:</strong><span id="summary-operador" class="font-medium">N/A</span>
                </div>
                <div class="flex justify-between">
                    <strong class="text-gray-500">OP / CP:</strong><span id="summary-op-cp" class="font-medium">N/A / N/A</span>
                </div>
                <div class="flex justify-between">
                    <strong class="text-gray-500">Início / Fim:</strong>
                    <span id="summary-start-end-time" class="font-medium text-right">N/A</span>
                </div>
            </div>

            <div class="mb-5">
                <label for="quantidade" class="block text-sm font-medium text-gray-700">Quantidade Produzida</label>
                <input type="number" id="quantidade" class="input-field" placeholder="0" min="0" required>
            </div>
            <!-- Campo de Tempo de Setup (minutos) REMOVIDO, pois o cálculo é automático -->
            
            <div class="mb-8">
                <label for="observacao" class="block text-sm font-medium text-gray-700">Observação (Opcional)</label>
                <textarea id="observacao" class="input-field" rows="3" placeholder="Qualquer problema ou nota relevante."></textarea>
            </div>

            <button onclick="saveFinalData(this)" class="btn-base btn-secondary w-full">Salvar Dados Finais</button>
        </div>

        <!-- Passo 5: Confirmação de Salvamento -->
        <div id="step-5" class="step hidden">
            <div class="text-center p-6">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto text-secondary mb-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                <h2 class="text-2xl font-bold mb-2 text-gray-800">Concluído!</h2>
                <p class="text-gray-600 mb-8">O registro foi salvo com sucesso. Seu foco fez a diferença.</p>
                <button onclick="resetApp()" class="btn-base btn-primary w-full">Iniciar Novo Registro</button>
            </div>
        </div>

    </div>
</div>

<!-- Added db.js script -->
<script src="db.js"></script>

<script>
    const appData = {
        operador: '',
        maquina: '',
        op: '',
        cp: '',
        startTime: null,
        endTime: null,
        durationSeconds: 0,
        // NOVO: Adicionado para controlar o modo (Setup ou Produção)
        isSetupMode: true, 
        // NOVO: Armazena a duração do setup após finalizado (em segundos)
        setupDurationSeconds: 0, 
        quantity: 0,
        observation: '',
        setupTime: 0, // setupTime no appData agora armazena a duração em segundos
        currentStep: 1, // Track current step
        prefSaveOperador: false,
        prefSaveMaquina: false,
    };

    let timerInterval = null;
    let saveStateInterval = null; // Auto-save interval
    const TIMER_DISPLAY = document.getElementById('timer-display');
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQXPruL9fpi7bsbLcOmZsaqanwMgWbWzqnp64v_kmJ7xI3FJznelkHuVK3w1ZjWr8M/exec'; // URL do Google Apps Script

    function formatDateTime(date) {
        if (!date) return 'N/A';
        const d = new Date(date);
        return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR');
    }

    function formatDuration(seconds) {
        if (seconds < 0) seconds = 0;
        const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
        const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
        const s = String(Math.floor(seconds % 60)).padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    function formatDurationToHHMMSS(seconds) {
        return formatDuration(seconds); // O formato já é HH:MM:SS
    }

    function showMessage(text, isError = false) {
        const box = document.getElementById('message-box');
        box.textContent = text;
        box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'border-red-400', 'bg-green-100', 'text-green-700', 'border-green-400');
        box.classList.add(isError ? 'bg-red-100' : 'bg-green-100');
        box.classList.add(isError ? 'text-red-700' : 'text-green-700');
        box.classList.add(isError ? 'border-red-400' : 'border-green-400');
        setTimeout(() => box.classList.add('hidden'), 5000);
    }

    async function saveState() {
        // Verifica se há tempo de inicio e se o passo é o 3 (Setup ou Produção)
        if (!appData.startTime || appData.currentStep !== 3) return;
        
        const stateToSave = {
            ...appData,
            startTime: appData.startTime ? appData.startTime.getTime() : null,
            endTime: appData.endTime ? appData.endTime.getTime() : null,
        };
        
        // Função do db.js para salvar o estado
        await saveCurrentState(stateToSave);
        console.log('[v0] State auto-saved');
    }

    async function restoreSession() {
        const state = await getCurrentState();
        if (!state) return;

        // Atribui as propriedades salvas
        Object.assign(appData, {
            ...state,
            startTime: state.startTime ? new Date(state.startTime) : null,
            endTime: state.endTime ? new Date(state.endTime) : null,
        });

        // Restaura campos
        document.getElementById('operador').value = appData.operador;
        document.getElementById('maquina').value = appData.maquina;
        document.getElementById('op').value = appData.op;
        document.getElementById('cp').value = appData.cp;
        document.getElementById('saveOperador').checked = appData.prefSaveOperador || false;
        document.getElementById('saveMaquina').checked = appData.prefSaveMaquina || false;


        document.getElementById('restore-banner').classList.add('hidden');

        if (appData.currentStep === 3 && appData.startTime) {
            // Recalcula tempo decorrido
            const now = new Date();
            const elapsed = Math.floor((now - appData.startTime) / 1000);
            appData.durationSeconds = elapsed;
            
            goToStep(3);
            
            // Reinicia o cronômetro
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
            
            showMessage('Sessão restaurada! Continuando...', false);
        } else {
            // Se o passo for 4, mostra o resumo
            if (appData.currentStep === 4) {
                 // Atualiza os resumos da tela 4 com os dados restaurados
                document.getElementById('summary-duration').textContent = formatDuration(appData.durationSeconds);
                // Exibe setup time no formato HH:MM:SS
                document.getElementById('summary-setup-time').textContent = formatDurationToHHMMSS(appData.setupDurationSeconds);
                document.getElementById('summary-operador').textContent = appData.operador;
                document.getElementById('summary-op-cp').textContent = `${appData.op} / ${appData.cp}`;
                document.getElementById('summary-start-end-time').textContent = `${formatDateTime(appData.startTime)} - ${formatDateTime(appData.endTime)}`;
            }
            goToStep(appData.currentStep);
        }
    }

    async function discardSession() {
        await clearCurrentState();
        document.getElementById('restore-banner').classList.add('hidden');
        resetApp(); 
    }

    function goToStep(stepNumber) {
        appData.currentStep = stepNumber;
        const steps = [1, 2, 3, 4, 5];
        steps.forEach(step => {
            const el = document.getElementById(`step-${step}`);
            if (el) el.classList.add('hidden');
        });
        const targetEl = document.getElementById(`step-${stepNumber}`);
        if (targetEl) targetEl.classList.remove('hidden');
        
        if (stepNumber >= 3) saveState();
        
        // Atualizar informações do Passo 3 ao mudar para ele
        if (stepNumber === 3) {
            document.getElementById('info-operador').textContent = appData.operador;
            document.getElementById('info-maquina').textContent = appData.maquina;
            document.getElementById('info-op-cp').textContent = `${appData.op} / ${appData.cp}`;
            updateStep3UI(); // Atualiza título e botões
        }
    }

    // Função para atualizar a UI do Passo 3 com base no modo (Setup/Produção)
    function updateStep3UI() {
        const title = document.getElementById('step-3-title');
        const status = document.getElementById('timer-status');
        const btnSetup = document.getElementById('btn-finish-setup');
        const btnProd = document.getElementById('btn-finish-production');

        if (appData.isSetupMode) {
            title.textContent = 'Setup em Curso';
            status.textContent = 'Tempo de Setup Decorrido';
            btnSetup.classList.remove('hidden');
            btnProd.classList.add('hidden');
        } else {
            title.textContent = 'Produção em Curso';
            status.textContent = 'Tempo de Produção Decorrido';
            btnSetup.classList.add('hidden');
            btnProd.classList.remove('hidden');
        }
    }

    function nextStep(currentStep) {
        if (currentStep === 1) {
            const operador = document.getElementById('operador').value.trim();
            const maquina = document.getElementById('maquina').value.trim();
            const saveOperador = document.getElementById('saveOperador').checked;
            const saveMaquina = document.getElementById('saveMaquina').checked;

            if (!operador || !maquina) {
                showMessage("Por favor, preencha o Nome do Operador e a Máquina.", true);
                return;
            }

            appData.operador = operador;
            appData.maquina = maquina;
            appData.prefSaveOperador = saveOperador;
            appData.prefSaveMaquina = saveMaquina;
            
            // Lógica de Salvar Preferências no localStorage
            if (saveOperador) {
                localStorage.setItem('savedOperador', operador);
            } else {
                localStorage.removeItem('savedOperador');
            }
            localStorage.setItem('prefSaveOperador', saveOperador ? 'true' : 'false');

            if (saveMaquina) {
                localStorage.setItem('savedMaquina', maquina);
            } else {
                localStorage.removeItem('savedMaquina');
            }
            localStorage.setItem('prefSaveMaquina', saveMaquina ? 'true' : 'false');
            
            goToStep(2);
        } else {
            goToStep(currentStep + 1);
        }
    }

    function prevStep(currentStep) {
        if (currentStep === 2) goToStep(1);
    }

    function initializeTimer(modeIsSetup) {
        const op = document.getElementById('op').value.trim();
        const cp = document.getElementById('cp').value.trim();

        if (!op || !cp) {
            showMessage("Por favor, preencha a OP e o CP para iniciar.", true);
            return false;
        }

        appData.op = op;
        appData.cp = cp;
        appData.startTime = new Date(); // Inicia o cronômetro
        appData.durationSeconds = 0;
        appData.isSetupMode = modeIsSetup; // Define o modo

        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);

        if (saveStateInterval) clearInterval(saveStateInterval);
        saveStateInterval = setInterval(saveState, 10000); // Salva a cada 10 segundos

        goToStep(3);
        saveState(); // Salva imediatamente
        return true;
    }

    // Função para iniciar o cronômetro no modo Setup (chamada pelo botão Iniciar Setup)
    async function startSetup() {
        if (initializeTimer(true)) {
            // Zera a duração do setup anterior e define modo Setup
            appData.setupDurationSeconds = 0; 
            showMessage(`Setup (OP: ${appData.op}) iniciado`, false);
        }
    }

    // Função para iniciar o cronômetro diretamente no modo Produção (chamada pelo botão Iniciar Produção)
    async function startProduction() {
        if (initializeTimer(false)) {
            // Zera setup duration e define modo Produção
            appData.setupDurationSeconds = 0; 
            showMessage(`Produção (OP: ${appData.op}) iniciada diretamente`, false);
        }
    }

    // Finaliza o Setup e reinicia o cronômetro para Produção
    async function finishSetup() {
        if (!appData.startTime) {
            showMessage("Erro: O setup não foi iniciado corretamente.", true);
            return;
        }

        const now = new Date();
        const elapsedSetup = Math.floor((now - appData.startTime) / 1000);
        
        if (elapsedSetup < 1) {
            showMessage("O tempo de Setup precisa ser maior que 0 segundos.", true);
            return;
        }

        // 1. Armazena o tempo de setup total
        appData.setupDurationSeconds = elapsedSetup;
        
        // 2. Reinicia o cronômetro para a Produção
        appData.startTime = new Date(); 
        appData.durationSeconds = 0; // Zera o contador de duração para Produção
        appData.isSetupMode = false; // Muda para o modo Produção
        
        // 3. Atualiza UI e salva o estado
        updateStep3UI(); 
        updateTimer();
        await saveState(); 
        
        showMessage(`Setup finalizado (${formatDurationToHHMMSS(elapsedSetup)}). Produção iniciada!`, false);
    }

    function updateTimer() {
        if (appData.startTime) {
            const now = new Date();
            const elapsed = Math.floor((now - appData.startTime) / 1000);
            appData.durationSeconds = elapsed;
            TIMER_DISPLAY.textContent = formatDuration(elapsed);
        }
    }

    async function finishProduction() {
        if (appData.isSetupMode) {
             showMessage("Você precisa Finalizar o Setup antes de Finalizar a Produção.", true);
             return;
        }
        
        if (timerInterval) clearInterval(timerInterval);
        if (saveStateInterval) clearInterval(saveStateInterval); 
        
        appData.endTime = new Date();

        if (appData.durationSeconds === 0) {
            showMessage("O tempo de produção precisa ser maior que 0 segundos.", true);
            return;
        }

        // Atualiza o resumo do Passo 4
        document.getElementById('summary-duration').textContent = formatDuration(appData.durationSeconds);
        // Exibe tempo de setup no formato HH:MM:SS
        document.getElementById('summary-setup-time').textContent = formatDurationToHHMMSS(appData.setupDurationSeconds); 
        document.getElementById('summary-operador').textContent = appData.operador;
        document.getElementById('summary-op-cp').textContent = `${appData.op} / ${appData.cp}`;
        document.getElementById('summary-start-end-time').textContent = `${formatDateTime(appData.startTime)} - ${formatDateTime(appData.endTime)}`;

        appData.setupTime = appData.setupDurationSeconds; 

        goToStep(4);
        await saveState(); // Salva o estado final
    }

    async function saveFinalData(saveButton) {
        const quantidade = document.getElementById('quantidade').value;
        const observacao = document.getElementById('observacao').value;

        if (quantidade === '' || isNaN(parseInt(quantidade))) {
            showMessage("Por favor, preencha a Quantidade Produzida.", true);
            return;
        }

        appData.quantity = parseInt(quantidade);
        appData.observation = observacao;
        
        if (SCRIPT_URL.includes('AKfycbxQXPruL9fpi7bsbLcOmZsaqanwMgWbWzqnp64v_kmj7xI3FJznelkHuVK3w1ZjWr8M') || !SCRIPT_URL.startsWith('https://')) {
            showMessage("ERRO: Por favor, configure a URL do Google Apps Script (variável SCRIPT_URL) para o URL 'exec' do seu deployment.", true);
            return;
        }

        // NOVO: Formato HH:MM:SS para o tempo de setup
        const setupTimeHHMMSS = formatDurationToHHMMSS(appData.setupTime);

        const dataToSend = {
            Operador: appData.operador,
            Maquina: appData.maquina,
            OP: appData.op,
            CP: appData.cp,
            HoraInicio: formatDateTime(appData.startTime),
            HoraFim: formatDateTime(appData.endTime),
            Duracao: formatDuration(appData.durationSeconds),
            Quantidade: appData.quantity,
            Observacao: appData.observation,
            // NOVO: Envia o tempo de setup no formato HH:MM:SS
            SetupMinutos: setupTimeHHMMSS, 
        };

        const btn = saveButton || document.querySelector('button[onclick*="saveFinalData"]');
        if (btn) { btn.disabled = true; btn.textContent = 'Enviando...'; }

        try {
            // Usa o fetch com 'no-cors' para envio simples de formulários via Apps Script
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                body: JSON.stringify(dataToSend)
            });

            // Como usamos 'no-cors', a resposta real não pode ser lida, mas assumimos sucesso se não houver erro de rede.

            showMessage("Dados enviados com sucesso! Verifique a planilha.", false);
            
            await clearCurrentState();
            
            goToStep(5);

        } catch (error) {
            console.error('Erro ao enviar dados:', error);
            showMessage("Erro ao salvar dados. Verifique a conexão ou a URL do Apps Script.", true);
            if (btn) { btn.disabled = false; btn.textContent = 'Salvar Dados Finais'; }
            return;
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'Salvar Dados Finais'; }
        }
    }

    // O parâmetro keepPrefs é opcional e false por default, mas é mais limpo carregar as preferências novamente
    async function resetApp() {
        // Limpar apenas os dados de sessão
        appData.startTime = null;
        appData.endTime = null;
        appData.durationSeconds = 0;
        appData.setupDurationSeconds = 0; // Zera o setup time
        appData.isSetupMode = true; // Volta para o modo Setup
        appData.quantity = 0;
        appData.observation = '';
        appData.setupTime = 0;
        if (!appData.prefSaveOperador) appData.operador = '';
        if (!appData.prefSaveMaquina) appData.maquina = '';
        appData.op = '';
        appData.cp = '';
        appData.currentStep = 1;

        // Limpar inputs da UI
        if (!appData.prefSaveOperador) document.getElementById('operador').value = '';
        if (!appData.prefSaveMaquina) document.getElementById('maquina').value = '';
        document.getElementById('op').value = '';
        document.getElementById('cp').value = '';
        document.getElementById('quantidade').value = '';
        document.getElementById('observacao').value = '';
        TIMER_DISPLAY.textContent = '00:00:00';

        if (timerInterval) clearInterval(timerInterval);
        if (saveStateInterval) clearInterval(saveStateInterval); 

        await clearCurrentState(); // Limpa o estado salvo no IndexedDB/localStorage
        
        // Recarrega as preferências para preencher campos se o "Lembrar" estiver ativo
        loadPreferences(); 
        
        goToStep(1);
    }
    
    // Função para carregar preferências e preencher campos
    function loadPreferences() {
        const operadorInput = document.getElementById('operador');
        const maquinaSelect = document.getElementById('maquina');
        const saveOperadorCheckbox = document.getElementById('saveOperador');
        const saveMaquinaCheckbox = document.getElementById('saveMaquina');

        // Preferência Operador
        const prefOperador = localStorage.getItem('prefSaveOperador');
        if (prefOperador === 'true') {
            const savedOperador = localStorage.getItem('savedOperador');
            if (savedOperador) {
                operadorInput.value = savedOperador;
                appData.operador = savedOperador;
            }
            saveOperadorCheckbox.checked = true;
            appData.prefSaveOperador = true;
        } else {
            saveOperadorCheckbox.checked = false;
            appData.prefSaveOperador = false;
        }

        // Preferência Máquina
        const prefMaquina = localStorage.getItem('prefSaveMaquina');
        if (prefMaquina === 'true') {
            const savedMaquina = localStorage.getItem('savedMaquina');
            if (savedMaquina) {
                maquinaSelect.value = savedMaquina;
                appData.maquina = savedMaquina;
            }
            saveMaquinaCheckbox.checked = true;
            appData.prefSaveMaquina = true;
        } else {
            saveMaquinaCheckbox.checked = false;
            appData.prefSaveMaquina = false;
        }
    }


    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Carrega as preferências de salvamento
        loadPreferences();
        
        // 2. Tenta restaurar a sessão
        const savedState = await getCurrentState();
        
        if (savedState && savedState.startTime && savedState.currentStep >= 3) {
            // Se houver estado válido, mostra o banner de restauração
            document.getElementById('restore-banner').classList.remove('hidden');
        } else {
            // Se não houver estado, inicia no passo 1
            goToStep(1);
        }
    });

    document.addEventListener('visibilitychange', () => {
        if (document.hidden && appData.startTime) {
            saveState();
            console.log('[v0] App went to background, state saved');
        }
    });

    window.addEventListener('beforeunload', () => {
        if (appData.startTime) {
            saveState();
        }
    });

    window.addEventListener('pagehide', () => {
        if (appData.startTime) {
            saveState();
        }
    });
</script>

<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log("Service Worker registrado!"))
    .catch(err => console.log("Erro ao registrar SW:", err));
}
</script>

</body>
</html>
