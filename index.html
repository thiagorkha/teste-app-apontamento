<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1D4ED8"> <!-- Cor primária nova -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Produção | Foco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Cores atualizadas para um visual mais moderno e profissional */
        :root {
            --primary: #1D4ED8; /* Azul Escuro */
            --secondary: #059669; /* Verde Industrial */
            --background: #f7f9fc; /* Fundo muito claro */
            --card: #ffffff; /* Cartão branco */
            --text-color: #1f2937; /* Texto escuro */
            --border-color: #e5e7eb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-color);
        }
        .container-app {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .card {
            background-color: var(--card);
            padding: 2rem;
            border-radius: 1.25rem; /* Mais arredondado */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 420px;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #1e40af;
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        /* Estilos para o banner de restauração e de instalação */
        #restore-banner, #install-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 50;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="p-0 m-0">

    <!-- Banner de Instalação PWA - Adicionado para dar controle ao usuário -->
    <div id="install-banner" class="hidden bg-gray-900 text-white p-3 shadow-xl">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <span class="text-sm font-medium">Instale o "Apontamento de Produção" como um aplicativo.</span>
            <button id="install-button" class="bg-secondary text-white text-sm font-semibold px-3 py-1 rounded-lg hover:bg-green-700 transition duration-150">
                Instalar App
            </button>
        </div>
    </div>

    <!-- Banner de Restauração de Sessão -->
    <div id="restore-banner" class="hidden bg-yellow-500 text-yellow-900 p-3 shadow-md">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <span class="text-sm font-medium">Sessão de produção anterior detectada.</span>
            <div>
                <button id="restore-session-btn" class="bg-yellow-700 text-white text-sm font-semibold px-3 py-1 rounded-lg hover:bg-yellow-800 transition duration-150 mr-2">
                    Restaurar
                </button>
                <button id="discard-session-btn" class="bg-yellow-900 text-white text-sm font-semibold px-3 py-1 rounded-lg hover:bg-yellow-950 transition duration-150">
                    Descartar
                </button>
            </div>
        </div>
    </div>

    <div class="container-app">
        <div class="card space-y-6">
            <h1 class="text-2xl font-bold text-center text-primary">Registro de Produção</h1>

            <!-- Passo 1: Seleção da Máquina -->
            <div id="step-1" class="step">
                <h2 class="text-xl font-semibold mb-4">1. Selecione a Máquina</h2>
                <input type="text" id="machine-name" placeholder="Ex: CNC 01 ou Linha de Montagem" class="w-full p-3 border border-border-color rounded-lg focus:ring-primary focus:border-primary">
                
                <div class="mt-4 flex items-center justify-between">
                    <label for="save-maquina" class="text-sm text-gray-600">Lembrar desta máquina na próxima vez?</label>
                    <input type="checkbox" id="save-maquina" class="h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary">
                </div>
                
                <button id="start-btn" class="w-full mt-6 btn-primary">
                    Avançar
                </button>
            </div>

            <!-- Passo 2: Confirmação e Início -->
            <div id="step-2" class="step">
                <h2 class="text-xl font-semibold mb-4">2. Confirmar Início</h2>
                <p class="text-lg mb-4">Máquina Selecionada: <span id="confirm-machine-name" class="font-bold text-primary"></span></p>
                <p class="mb-6 text-sm text-gray-600">Ao clicar em "Iniciar Produção", o cronômetro será iniciado.</p>

                <div class="flex space-x-4">
                    <button id="back-step-2" class="w-1/3 p-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
                        Voltar
                    </button>
                    <button id="confirm-start-btn" class="w-2/3 btn-primary">
                        Iniciar Produção
                    </button>
                </div>
            </div>

            <!-- Passo 3: Produção em Andamento -->
            <div id="step-3" class="step">
                <h2 class="text-xl font-semibold mb-4">3. Produção em Andamento</h2>
                <p class="text-md mb-2">Máquina: <span id="current-machine-name" class="font-bold text-primary"></span></p>
                <p class="text-2xl font-extrabold text-center my-6">
                    Tempo: <span id="timer" class="text-secondary">00:00:00</span>
                </p>

                <button id="pause-btn" class="w-full mt-4 p-3 bg-orange-500 text-white font-semibold rounded-lg hover:bg-orange-600 transition duration-150">
                    Pausar
                </button>
                <button id="finish-btn" class="w-full mt-4 p-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150">
                    Finalizar Produção
                </button>
            </div>

            <!-- Passo 4: Pausa -->
            <div id="step-4" class="step">
                <h2 class="text-xl font-semibold mb-4">4. Pausa</h2>
                <p class="text-md mb-2">Máquina: <span id="paused-machine-name" class="font-bold text-primary"></span></p>
                <p class="text-xl font-semibold text-center my-6 text-gray-700">
                    Produção Pausada.
                </p>
                <p class="mb-4 text-sm text-center text-gray-600">
                    Tempo total de produção: <span id="paused-timer" class="font-bold text-secondary">00:00:00</span>
                </p>

                <div class="space-y-4">
                    <input type="text" id="pause-reason" placeholder="Motivo da Pausa (Opcional)" class="w-full p-3 border border-border-color rounded-lg focus:ring-primary focus:border-primary">
                    <input type="text" id="pause-duration" placeholder="Duração da Pausa (minutos - Opcional)" class="w-full p-3 border border-border-color rounded-lg focus:ring-primary focus:border-primary">
                </div>
                
                <button id="resume-btn" class="w-full mt-6 btn-primary">
                    Retomar Produção
                </button>
                <button id="cancel-pause-btn" class="w-full mt-3 p-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
                    Voltar para Início
                </button>
            </div>

            <!-- Passo 5: Resultado -->
            <div id="step-5" class="step">
                <h2 class="text-xl font-semibold mb-4">5. Resumo da Produção</h2>
                <p class="text-md mb-2">Máquina: <span id="result-machine-name" class="font-bold text-primary"></span></p>
                <p class="text-lg mb-2">Duração Total: <span id="result-total-time" class="font-bold text-secondary">00:00:00</span></p>
                <p class="text-lg mb-2">Motivo da Pausa: <span id="result-pause-reason" class="font-semibold text-gray-700 italic">N/A</span></p>
                <p class="text-lg mb-4">Duração da Pausa: <span id="result-pause-duration" class="font-semibold text-gray-700">0 min</span></p>

                <div class="space-y-4">
                    <input type="number" id="produced-quantity" placeholder="Quantidade Produzida" class="w-full p-3 border border-border-color rounded-lg focus:ring-primary focus:border-primary">
                    <textarea id="notes" placeholder="Observações Finais (Opcional)" rows="3" class="w-full p-3 border border-border-color rounded-lg focus:ring-primary focus:border-primary"></textarea>
                </div>

                <button id="save-and-new-btn" class="w-full mt-6 btn-primary">
                    Salvar e Iniciar Novo
                </button>
            </div>

            <!-- Mensagem de Erro/Aviso (Customizada) -->
            <div id="message-box" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full space-y-4">
                    <h3 id="message-title" class="text-xl font-bold text-primary">Aviso</h3>
                    <p id="message-text" class="text-gray-700"></p>
                    <button id="close-message-box" class="w-full btn-primary">
                        Entendido
                    </button>
                </div>
            </div>

        </div>
    </div>

<script type="module">
    // Importa as funções do IndexedDB/Service Worker
    import { getCurrentState, saveState, clearCurrentState, saveToQueue } from "./db.js";

    // Variáveis Globais
    let appData = {
        machineName: '',
        startTime: null,
        pauseTime: null,
        currentStep: 1,
        timerInterval: null,
        totalProductionTime: 0, // Tempo total em milissegundos
        pauseReason: '',
        pauseDurationMinutes: 0,
        prefSaveMaquina: false,
    };

    // Variável para armazenar o evento de instalação (PWA)
    let deferredInstallPrompt = null;

    // Elementos DOM
    const steps = [1, 2, 3, 4, 5].map(n => document.getElementById(`step-${n}`));
    const startBtn = document.getElementById('start-btn');
    const machineNameInput = document.getElementById('machine-name');
    const confirmMachineNameSpan = document.getElementById('confirm-machine-name');
    const currentMachineNameSpan = document.getElementById('current-machine-name');
    const pausedMachineNameSpan = document.getElementById('paused-machine-name');
    const resultMachineNameSpan = document.getElementById('result-machine-name');
    const confirmStartBtn = document.getElementById('confirm-start-btn');
    const backStep2Btn = document.getElementById('back-step-2');
    const timerSpan = document.getElementById('timer');
    const pauseBtn = document.getElementById('pause-btn');
    const finishBtn = document.getElementById('finish-btn');
    const resumeBtn = document.getElementById('resume-btn');
    const restoreBanner = document.getElementById('restore-banner');
    const restoreSessionBtn = document.getElementById('restore-session-btn');
    const discardSessionBtn = document.getElementById('discard-session-btn');
    const saveMaquinaCheckbox = document.getElementById('save-maquina');
    const pausedTimerSpan = document.getElementById('paused-timer');
    const pauseReasonInput = document.getElementById('pause-reason');
    const pauseDurationInput = document.getElementById('pause-duration');
    const cancelPauseBtn = document.getElementById('cancel-pause-btn');
    const resultTotalTimeSpan = document.getElementById('result-total-time');
    const resultPauseReasonSpan = document.getElementById('result-pause-reason');
    const resultPauseDurationSpan = document.getElementById('result-pause-duration');
    const producedQuantityInput = document.getElementById('produced-quantity');
    const notesTextarea = document.getElementById('notes');
    const saveAndNewBtn = document.getElementById('save-and-new-btn');
    const installBanner = document.getElementById('install-banner');
    const installButton = document.getElementById('install-button');
    const messageBox = document.getElementById('message-box');
    const messageTitle = document.getElementById('message-title');
    const messageText = document.getElementById('message-text');
    const closeMessageBox = document.getElementById('close-message-box');


    // --- Funções de Utilidade ---

    /**
     * Exibe a caixa de mensagem customizada.
     * @param {string} title Título da mensagem.
     * @param {string} text Texto do corpo da mensagem.
     */
    function showMessage(title, text) {
        messageTitle.textContent = title;
        messageText.textContent = text;
        messageBox.classList.remove('hidden');
    }

    /**
     * Fecha a caixa de mensagem customizada.
     */
    function closeMessage() {
        messageBox.classList.add('hidden');
    }

    // Listener para fechar a mensagem
    closeMessageBox.addEventListener('click', closeMessage);

    /**
     * Formata um tempo em milissegundos para HH:MM:SS.
     * @param {number} ms Tempo em milissegundos.
     * @returns {string} Tempo formatado.
     */
    function formatTime(ms) {
        if (ms < 0) ms = 0;
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        const pad = (num) => String(num).padStart(2, '0');
        return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    }

    /**
     * Atualiza o estado da aplicação e salva no IndexedDB.
     */
    function updateAndSaveState() {
        // Recalcula o tempo de produção (apenas se estiver ativo/passo 3)
        if (appData.currentStep === 3 && appData.startTime) {
            appData.totalProductionTime = new Date().getTime() - appData.startTime;
        }

        // Garante que o totalProductionTime é sempre armazenado (mesmo se pausado)
        saveState({
            machineName: appData.machineName,
            startTime: appData.startTime,
            pauseTime: appData.pauseTime,
            currentStep: appData.currentStep,
            totalProductionTime: appData.totalProductionTime,
            pauseReason: appData.pauseReason,
            pauseDurationMinutes: appData.pauseDurationMinutes,
        });
    }

    /**
     * Transiciona para a etapa (Step) fornecida.
     * @param {number} stepNumber O número da etapa para onde transicionar.
     */
    function goToStep(stepNumber) {
        appData.currentStep = stepNumber;
        steps.forEach(step => step.classList.remove('active'));

        const newStep = document.getElementById(`step-${stepNumber}`);
        if (newStep) {
            newStep.classList.add('active');
        }

        // Atualiza a interface (máquina e tempo)
        updateUI();
        updateAndSaveState();
    }

    /**
     * Inicia/Reinicia o cronômetro.
     */
    function startTimer() {
        if (appData.timerInterval) {
            clearInterval(appData.timerInterval);
        }

        // Se o startTime for nulo, define ele com base no tempo atual
        if (!appData.startTime) {
            appData.startTime = new Date().getTime();
            appData.totalProductionTime = 0;
        }

        appData.timerInterval = setInterval(() => {
            appData.totalProductionTime = new Date().getTime() - appData.startTime;
            timerSpan.textContent = formatTime(appData.totalProductionTime);
            // Salva o estado a cada 5 segundos para persistência
            if (Math.floor(appData.totalProductionTime / 1000) % 5 === 0) {
                updateAndSaveState();
            }
        }, 1000);

        updateAndSaveState();
    }

    /**
     * Para o cronômetro (não zera o tempo acumulado).
     */
    function stopTimer() {
        if (appData.timerInterval) {
            clearInterval(appData.timerInterval);
            appData.timerInterval = null;
        }
        // Garante que o tempo finalizado seja salvo.
        updateAndSaveState();
    }

    /**
     * Atualiza os textos dinâmicos na interface (nome da máquina e tempos).
     */
    function updateUI() {
        const name = appData.machineName || 'N/A';
        
        // Atualiza todos os spans de nome de máquina
        [confirmMachineNameSpan, currentMachineNameSpan, pausedMachineNameSpan, resultMachineNameSpan].forEach(span => {
            if (span) span.textContent = name;
        });

        // Atualiza o timer do passo 3
        if (appData.currentStep === 3) {
            timerSpan.textContent = formatTime(appData.totalProductionTime);
        }
        // Atualiza o timer do passo 4
        if (appData.currentStep === 4) {
             pausedTimerSpan.textContent = formatTime(appData.totalProductionTime);
        }
        // Atualiza o resultado do passo 5
        if (appData.currentStep === 5) {
            resultTotalTimeSpan.textContent = formatTime(appData.totalProductionTime);
            resultPauseReasonSpan.textContent = appData.pauseReason || 'Nenhum';
            resultPauseDurationSpan.textContent = `${appData.pauseDurationMinutes} min`;
        }
    }

    /**
     * Carrega as preferências de salvamento do localStorage.
     */
    function loadPreferences() {
        const savedPref = localStorage.getItem('producao-pref-maquina');
        if (savedPref) {
            appData.prefSaveMaquina = JSON.parse(savedPref);
        }

        // Carrega o nome da máquina se a preferência estiver ativa
        if (appData.prefSaveMaquina) {
            const savedMachine = localStorage.getItem('producao-machine-name');
            if (savedMachine) {
                machineNameInput.value = savedMachine;
            }
        }
        saveMaquinaCheckbox.checked = appData.prefSaveMaquina;
    }

    /**
     * Salva as preferências no localStorage.
     */
    function savePreferences() {
        localStorage.setItem('producao-pref-maquina', appData.prefSaveMaquina);
        if (appData.prefSaveMaquina) {
            localStorage.setItem('producao-machine-name', appData.machineName);
        } else {
            localStorage.removeItem('producao-machine-name');
        }
    }


    // --- Listeners de Eventos ---

    // Passo 1: Iniciar
    startBtn.addEventListener('click', () => {
        const name = machineNameInput.value.trim();
        if (!name) {
            showMessage("Erro", "Por favor, insira o nome da máquina.");
            return;
        }
        appData.machineName = name;
        appData.prefSaveMaquina = saveMaquinaCheckbox.checked;
        savePreferences();
        goToStep(2);
    });

    // Passo 2: Voltar
    backStep2Btn.addEventListener('click', () => {
        goToStep(1);
    });

    // Passo 2: Confirmar Início
    confirmStartBtn.addEventListener('click', () => {
        // Limpa estado se houver algum
        clearCurrentState();
        
        appData.startTime = new Date().getTime();
        appData.totalProductionTime = 0;
        appData.pauseTime = null; // Garante que a pausa está limpa
        appData.pauseReason = ''; // Garante que o motivo da pausa está limpo
        appData.pauseDurationMinutes = 0; // Garante que a duração da pausa está limpa

        goToStep(3);
        startTimer();
    });

    // Passo 3: Pausar
    pauseBtn.addEventListener('click', () => {
        stopTimer();
        appData.pauseTime = new Date().getTime();
        pauseReasonInput.value = ''; // Limpa campos ao entrar na pausa
        pauseDurationInput.value = '';
        goToStep(4);
    });

    // Passo 3: Finalizar
    finishBtn.addEventListener('click', () => {
        stopTimer();
        // Verifica se há pelo menos 1 segundo de produção
        if (appData.totalProductionTime < 1000) {
            showMessage("Erro", "A produção deve ter pelo menos 1 segundo de duração para ser finalizada.");
            startTimer(); // Reinicia o timer para o usuário continuar
            return;
        }

        // Prepara os campos de resultado e vai para o passo 5
        producedQuantityInput.value = '';
        notesTextarea.value = '';
        goToStep(5);
    });

    // Passo 4: Retomar
    resumeBtn.addEventListener('click', () => {
        // Calcula a duração da pausa (em minutos)
        const durationMinutes = parseFloat(pauseDurationInput.value.replace(',', '.')) || 0;
        
        // Atualiza os dados da pausa
        appData.pauseReason = pauseReasonInput.value.trim();
        appData.pauseDurationMinutes += durationMinutes;

        // Ajusta o tempo de início para que o totalProductionTime seja mantido (não descontando o tempo da pausa real)
        const now = new Date().getTime();
        const pauseDurationMs = (now - appData.pauseTime); // Duração real da pausa na tela
        
        // O novo startTime é o atual menos o tempo que já havia de produção
        // Isso garante que o cronômetro recomece do ponto onde parou no passo 3
        appData.startTime = now - appData.totalProductionTime; 
        appData.pauseTime = null; // Limpa o tempo de pausa
        
        goToStep(3);
        startTimer();
    });

    // Passo 4: Cancelar Pausa / Voltar para Início
    cancelPauseBtn.addEventListener('click', () => {
        stopTimer();
        // Limpa os dados de produção (similar a um descarte)
        clearCurrentState();
        
        // Resetar appData para o estado inicial
        appData = {
            machineName: appData.prefSaveMaquina ? appData.machineName : '', // Mantém o nome da máquina se for preferência
            startTime: null,
            pauseTime: null,
            currentStep: 1,
            timerInterval: null,
            totalProductionTime: 0,
            pauseReason: '',
            pauseDurationMinutes: 0,
            prefSaveMaquina: appData.prefSaveMaquina,
        };
        // Garante que a checkbox reflita o estado
        saveMaquinaCheckbox.checked = appData.prefSaveMaquina;
        
        // Vai para o passo 1
        goToStep(1);
    });

    // Passo 5: Salvar e Novo
    saveAndNewBtn.addEventListener('click', async () => {
        const quantity = parseInt(producedQuantityInput.value, 10);

        if (isNaN(quantity) || quantity < 0) {
            showMessage("Erro", "Por favor, insira uma Quantidade Produzida válida (número não negativo).");
            return;
        }

        const data = {
            machineName: appData.machineName,
            productionTimeMs: appData.totalProductionTime,
            productionTimeFormatted: formatTime(appData.totalProductionTime),
            pauseReason: appData.pauseReason,
            pauseDurationMinutes: appData.pauseDurationMinutes,
            producedQuantity: quantity,
            notes: notesTextarea.value.trim(),
            timestamp: new Date().toISOString(),
        };

        try {
            await saveToQueue(data);
            await clearCurrentState();
            showMessage("Sucesso!", "Dados de produção salvos e prontos para sincronização.");
        } catch (error) {
            console.error("Erro ao salvar dados de produção:", error);
            showMessage("Erro", "Falha ao salvar os dados localmente. Verifique o console para detalhes.");
        }

        // Resetar appData (mantendo o nome da máquina se for preferência)
        appData = {
            machineName: appData.prefSaveMaquina ? appData.machineName : '',
            startTime: null,
            pauseTime: null,
            currentStep: 1,
            timerInterval: null,
            totalProductionTime: 0,
            pauseReason: '',
            pauseDurationMinutes: 0,
            prefSaveMaquina: appData.prefSaveMaquina,
        };
        // Garante que a checkbox reflita o estado
        saveMaquinaCheckbox.checked = appData.prefSaveMaquina;
        machineNameInput.value = appData.machineName;

        // Vai para o passo 1
        goToStep(1);
    });

    // Restauração de Sessão
    restoreSessionBtn.addEventListener('click', async () => {
        const savedState = await getCurrentState();
        if (savedState) {
            // Recarrega o estado nos dados da aplicação
            appData.machineName = savedState.machineName;
            appData.startTime = savedState.startTime;
            appData.pauseTime = savedState.pauseTime;
            appData.totalProductionTime = savedState.totalProductionTime || 0;
            appData.pauseReason = savedState.pauseReason || '';
            appData.pauseDurationMinutes = savedState.pauseDurationMinutes || 0;

            // Decide para qual passo ir (3 se estiver em execução, 4 se estiver pausado)
            const targetStep = (savedState.currentStep === 3 || savedState.currentStep === 4) 
                ? savedState.currentStep 
                : 3; // Padrão para 3 se o estado for inconsistente (ex: 5)
            
            restoreBanner.classList.add('hidden');
            goToStep(targetStep);
            
            if (targetStep === 3) {
                // Se for para o passo 3, reinicia o cronômetro
                startTimer();
            } else if (targetStep === 4) {
                 // Se for para o passo 4, apenas garante que a UI esteja atualizada (o cronômetro já está parado)
                 stopTimer();
                 // Atualiza os campos de pausa com os dados salvos
                 pauseReasonInput.value = appData.pauseReason;
                 pauseDurationInput.value = appData.pauseDurationMinutes;
                 updateUI();
            }
            console.log('[v0] Sessão restaurada para o passo:', targetStep);
        }
    });

    // Descarte de Sessão
    discardSessionBtn.addEventListener('click', async () => {
        await clearCurrentState();
        restoreBanner.classList.add('hidden');
        // Resetar appData (mantendo o nome da máquina se for preferência)
        appData = {
            machineName: appData.prefSaveMaquina ? appData.machineName : '',
            startTime: null,
            pauseTime: null,
            currentStep: 1,
            timerInterval: null,
            totalProductionTime: 0,
            pauseReason: '',
            pauseDurationMinutes: 0,
            prefSaveMaquina: appData.prefSaveMaquina,
        };
        // Garante que a checkbox reflita o estado
        saveMaquinaCheckbox.checked = appData.prefSaveMaquina;
        machineNameInput.value = appData.machineName;

        goToStep(1);
        showMessage("Descarte", "A sessão de produção anterior foi descartada.");
        console.log('[v0] Sessão anterior descartada');
    });

    // Toggle de Preferência de Salvar Máquina
    saveMaquinaCheckbox.addEventListener('change', () => {
        appData.prefSaveMaquina = saveMaquinaCheckbox.checked;
        savePreferences();
    });

    // --- Lógica PWA de Instalação (Adicionado para resolver o problema) ---
    window.addEventListener('beforeinstallprompt', (event) => {
        // Previne o prompt padrão do navegador
        event.preventDefault();
        // Armazena o evento para ser disparado depois
        deferredInstallPrompt = event;
        // Mostra o banner customizado de instalação
        installBanner.classList.remove('hidden');
        console.log('[v0] Evento beforeinstallprompt capturado. Banner de instalação exibido.');
    });

    installButton.addEventListener('click', () => {
        if (deferredInstallPrompt) {
            // Oculta o banner customizado (será exibido novamente se a instalação falhar/cancelar)
            installBanner.classList.add('hidden');
            // Dispara o prompt nativo de instalação
            deferredInstallPrompt.prompt();

            // Espera pela escolha do usuário
            deferredInstallPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('[v0] Usuário aceitou a instalação do PWA.');
                    showMessage("Instalação", "O aplicativo foi instalado com sucesso!");
                } else {
                    console.log('[v0] Usuário recusou a instalação do PWA.');
                    installBanner.classList.remove('hidden'); // Mostra o banner novamente
                }
                deferredInstallPrompt = null; // O evento só pode ser usado uma vez
            });
        }
    });
    // --- Fim da Lógica PWA de Instalação ---


    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Carrega as preferências de salvamento
        loadPreferences();
        
        // 2. Tenta restaurar a sessão
        const savedState = await getCurrentState();
        
        if (savedState && savedState.startTime && savedState.currentStep >= 3) {
            // Se houver estado válido, mostra o banner de restauração
            document.getElementById('restore-banner').classList.remove('hidden');
        } else {
            // Se não houver estado, inicia no passo 1
            goToStep(1);
        }
    });

    document.addEventListener('visibilitychange', () => {
        if (document.hidden && appData.startTime) {
            // Salva o estado ao sair da aplicação (em produção)
            updateAndSaveState();
            console.log('[v0] App foi para o background, estado salvo');
        }
    });

    // Eventos de saída do navegador
    window.addEventListener('beforeunload', () => {
        if (appData.startTime) {
            updateAndSaveState();
        }
    });

    window.addEventListener('pagehide', () => {
        if (appData.startTime) {
            updateAndSaveState();
        }
    });
</script>

<script>
// Registro do Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log("Service Worker registrado com sucesso!"))
    .catch(err => console.log("Erro ao registrar Service Worker:", err));
}
</script>

</body>
</html>
