<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1D4ED8"> <!-- Cor primária nova -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Produção | Foco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Cores atualizadas para um visual mais moderno e profissional */
        :root {
            --primary: #1D4ED8; /* Azul Escuro */
            --secondary: #059669; /* Verde Industrial */
            --background: #f7f9fc; /* Fundo muito claro */
            --card: #ffffff; /* Cartão branco */
            --text-color: #1f2937; /* Texto escuro */
            --border-color: #e5e7eb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-color);
        }
        .container-app {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .card {
            background-color: var(--card);
            padding: 2rem;
            border-radius: 1.25rem; /* Mais arredondado */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05); /* Sombra mais profunda */
            border: 1px solid var(--border-color); /* Borda sutil */
            width: 100%;
            max-width: 420px;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem; /* Mais arredondado */
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            margin-top: 0.5rem;
            background-color: #f9fafb; /* Fundo levemente cinza */
        }
        .input-field:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.2);
            background-color: var(--card);
        }
        .btn-base {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            width: 100%;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-base:active {
            transform: translateY(1px);
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: #1E40AF;
        }
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        .btn-secondary:hover {
            background-color: #047857;
        }
        .summary-info-block {
            background-color: #f3f4f6; /* Fundo cinza suave */
            padding: 1rem;
            border-radius: 0.75rem;
            border-left: 4px solid var(--primary);
        }
        .timer-display-area {
            background-color: var(--text-color); /* Fundo escuro para contraste */
            color: #10B981; /* Verde neon para o timer */
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            font-size: 2.5rem; /* Maior */
            letter-spacing: 2px;
            font-family: monospace;
        }
        /* Style for restore banner */
        .restore-banner {
            background-color: #fffbeb;
            border: 2px solid #f59e0b;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>

<div class="container-app">
    <div class="card">
        <h1 id="app-title" class="text-3xl font-extrabold mb-8 text-center text-gray-900 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7 mr-2 text-primary">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
            Foco Produção
        </h1>

        <!-- Banner de Restauração -->
        <div id="restore-banner" class="restore-banner hidden">
            <p class="text-sm font-bold text-amber-800 mb-2 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1 text-amber-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.021 3.375 1.767 3.375h14.468c1.745 0 2.632-1.875 1.767-3.375L13.5 7.5c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                </svg>
                Sessão em Andamento
            </p>
            <p class="text-xs text-amber-700 mb-4">Continuar a produção anterior ou iniciar um novo registro?</p>
            <div class="flex gap-3">
                <button onclick="restoreSession()" class="btn-secondary text-sm py-2">Continuar</button>
                <button onclick="discardSession()" class="btn-primary text-sm py-2 opacity-80 bg-red-600 hover:bg-red-700">Descartar</button>
            </div>
        </div>

        <div id="message-box" class="hidden p-3 mb-4 rounded-xl text-center text-sm font-medium border" role="alert"></div>

        <!-- Passo 1: Informações Básicas -->
        <div id="step-1" class="step">
            <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">Identificação</h2>
            
            <div class="mb-5">
                <label for="operador" class="block text-sm font-medium text-gray-700">Nome do Operador</label>
                <input type="text" id="operador" class="input-field" placeholder="Ex: João Silva" required>
                <!-- Opção para salvar o nome do operador -->
                <div class="flex items-center mt-2">
                    <input id="saveOperador" type="checkbox" class="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary">
                    <label for="saveOperador" class="ml-2 block text-sm text-gray-600">Lembrar Operador</label>
                </div>
            </div>

            <div class="mb-8">
                <label for="maquina" class="block text-sm font-medium text-gray-700">Máquina / Linha</label>
                <select id="maquina" class="input-field">
                    <option value="">Selecione...</option>
                    <option>Romi D1000</option>
                    <option>Veker Mvk 1050</option>
                    <option>Torno Cnc Cosmos</option>
                    <option>Torno Convencional</option>
                    <option>Torno Mascote</option>
                    <option>Fresadora Ferramenteira</option>
                </select>
                <!-- Opção para salvar a máquina -->
                <div class="flex items-center mt-2">
                    <input id="saveMaquina" type="checkbox" class="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary">
                    <label for="saveMaquina" class="ml-2 block text-sm text-gray-600">Lembrar Máquina</label>
                </div>
            </div>

            <button onclick="nextStep(1)" class="btn-base btn-primary">Prosseguir</button>
        </div>

        <!-- Passo 2: Informações da Ordem de Produção -->
        <div id="step-2" class="step hidden">
            <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">Detalhes da Produção</h2>
            <div class="mb-5">
                <label for="op" class="block text-sm font-medium text-gray-700">Ordem de Produção (OP)</label>
                <input type="text" id="op" class="input-field" placeholder="Ex: 2024-12345" required>
            </div>
            <div class="mb-8">
                <label for="cp" class="block text-sm font-medium text-gray-700">Código do Produto (CP)</label>
                <input type="text" id="cp" class="input-field" placeholder="Ex: PROD-A01" required>
            </div>
            <button onclick="startProduction()" class="btn-base btn-secondary">
                <div class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.985V5.653Z" />
                    </svg>
                    Iniciar Cronômetro
                </div>
            </button>
            <button onclick="prevStep(2)" class="btn-base btn-primary mt-3 opacity-75 bg-gray-400 hover:bg-gray-500">Voltar</button>
        </div>

        <!-- Passo 3: Cronômetro de Produção -->
        <div id="step-3" class="step hidden">
            <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">Produção em Curso</h2>
            
            <!-- Resumo de informações acima do cronômetro (Design melhorado) -->
            <div id="step-3-summary" class="summary-info-block mb-6 grid grid-cols-2 gap-3 text-sm">
                <div>
                    <strong class="text-gray-500 font-medium">Operador</strong>
                    <span id="info-operador" class="block font-semibold text-gray-800">N/A</span>
                </div>
                <div>
                    <strong class="text-gray-500 font-medium">Máquina</strong>
                    <span id="info-maquina" class="block font-semibold text-gray-800">N/A</span>
                </div>
                <div class="col-span-2">
                    <strong class="text-gray-500 font-medium">OP / Produto</strong>
                    <span id="info-op-cp" class="block font-semibold text-gray-800">N/A / N/A</span>
                </div>
            </div>

            <div class="text-center mb-8 timer-display-area">
                <p class="font-bold" id="timer-display">00:00:00</p>
                <p class="text-xs text-gray-400 mt-2 tracking-normal">Tempo Decorrido</p>
            </div>
            <button onclick="finishProduction()" class="btn-base btn-primary bg-red-600 hover:bg-red-700">
                <div class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    Finalizar e Registrar
                </div>
            </button>
        </div>

        <!-- Passo 4: Resumo e Dados Finais -->
        <div id="step-4" class="step hidden">
            <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">Dados Finais</h2>

            <div class="space-y-3 p-4 mb-6 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                <div class="flex justify-between">
                    <strong class="text-gray-500">Duração Total:</strong><span id="summary-duration" class="font-semibold text-secondary">00:00:00</span>
                </div>
                <div class="flex justify-between">
                    <strong class="text-gray-500">Operador:</strong><span id="summary-operador" class="font-medium">N/A</span>
                </div>
                <div class="flex justify-between">
                    <strong class="text-gray-500">OP / CP:</strong><span id="summary-op-cp" class="font-medium">N/A / N/A</span>
                </div>
                <div class="flex justify-between">
                    <strong class="text-gray-500">Início / Fim:</strong>
                    <span id="summary-start-end-time" class="font-medium text-right">N/A</span>
                </div>
            </div>

            <div class="mb-5">
                <label for="quantidade" class="block text-sm font-medium text-gray-700">Quantidade Produzida</label>
                <input type="number" id="quantidade" class="input-field" placeholder="0" min="0" required>
            </div>
            <div class="mb-5">
                <label for="setupTime" class="block text-sm font-medium text-gray-700">Tempo de Setup (minutos)</label>
                <input type="number" id="setupTime" min="0" class="input-field" placeholder="Ex.: 12">
            </div>
            <div class="mb-8">
                <label for="observacao" class="block text-sm font-medium text-gray-700">Observação (Opcional)</label>
                <textarea id="observacao" class="input-field" rows="3" placeholder="Qualquer problema ou nota relevante."></textarea>
            </div>

            <button onclick="saveFinalData(this)" class="btn-base btn-secondary">Salvar Dados Finais</button>
        </div>

        <!-- Passo 5: Confirmação de Salvamento -->
        <div id="step-5" class="step hidden">
            <div class="text-center p-6">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto text-secondary mb-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                <h2 class="text-2xl font-bold mb-2 text-gray-800">Concluído!</h2>
                <p class="text-gray-600 mb-8">O registro foi salvo com sucesso. Seu foco fez a diferença.</p>
                <button onclick="resetApp()" class="btn-base btn-primary">Iniciar Novo Registro</button>
            </div>
        </div>

    </div>
</div>

<!-- Added db.js script -->
<script src="db.js"></script>

<script>
    const appData = {
        operador: '',
        maquina: '',
        op: '',
        cp: '',
        startTime: null,
        endTime: null,
        durationSeconds: 0,
        quantity: 0,
        observation: '',
        setupTime: '',
        currentStep: 1, // Track current step
        prefSaveOperador: false,
        prefSaveMaquina: false,
    };

    let timerInterval = null;
    let saveStateInterval = null; // Auto-save interval
    const TIMER_DISPLAY = document.getElementById('timer-display');
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQXPruL9fpi7bsbLcOmZsaqanwMgWbWzqnp64v_kmJ7xI3FJznelkHuVK3w1ZjWr8M/exec'; // URL do Google Apps Script

    function formatDateTime(date) {
        if (!date) return 'N/A';
        const d = new Date(date);
        return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR');
    }

    function formatDuration(seconds) {
        if (seconds < 0) seconds = 0;
        const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
        const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
        const s = String(Math.floor(seconds % 60)).padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    function showMessage(text, isError = false) {
        const box = document.getElementById('message-box');
        box.textContent = text;
        box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'border-red-400', 'bg-green-100', 'text-green-700', 'border-green-400');
        box.classList.add(isError ? 'bg-red-100' : 'bg-green-100');
        box.classList.add(isError ? 'text-red-700' : 'text-green-700');
        box.classList.add(isError ? 'border-red-400' : 'border-green-400');
        setTimeout(() => box.classList.add('hidden'), 5000);
    }

    async function saveState() {
        if (!appData.startTime || appData.currentStep < 3) return;
        
        const stateToSave = {
            ...appData,
            startTime: appData.startTime ? appData.startTime.getTime() : null,
            endTime: appData.endTime ? appData.endTime.getTime() : null,
        };
        
        // Função do db.js para salvar o estado
        await saveCurrentState(stateToSave);
        console.log('[v0] State auto-saved');
    }

    async function restoreSession() {
        const state = await getCurrentState();
        if (!state) return;

        // Atribui as propriedades salvas
        Object.assign(appData, {
            ...state,
            startTime: state.startTime ? new Date(state.startTime) : null,
            endTime: state.endTime ? new Date(state.endTime) : null,
        });

        // Restaura campos
        document.getElementById('operador').value = appData.operador;
        document.getElementById('maquina').value = appData.maquina;
        document.getElementById('op').value = appData.op;
        document.getElementById('cp').value = appData.cp;
        document.getElementById('saveOperador').checked = appData.prefSaveOperador || false;
        document.getElementById('saveMaquina').checked = appData.prefSaveMaquina || false;


        document.getElementById('restore-banner').classList.add('hidden');

        if (appData.currentStep === 3 && appData.startTime) {
            // Recalcula tempo decorrido
            const now = new Date();
            const elapsed = Math.floor((now - appData.startTime) / 1000);
            appData.durationSeconds = elapsed;
            
            goToStep(3);
            
            // Reinicia o cronômetro
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
            
            showMessage('Sessão restaurada! Continuando produção...', false);
        } else {
            // Se o passo for 4, mostra o resumo
            if (appData.currentStep === 4) {
                 // Atualiza os resumos da tela 4 com os dados restaurados
                document.getElementById('summary-duration').textContent = formatDuration(appData.durationSeconds);
                document.getElementById('summary-operador').textContent = appData.operador;
                document.getElementById('summary-op-cp').textContent = `${appData.op} / ${appData.cp}`;
                document.getElementById('summary-start-end-time').textContent = `${formatDateTime(appData.startTime)} - ${formatDateTime(appData.endTime)}`;
            }
            goToStep(appData.currentStep);
        }
    }

    async function discardSession() {
        await clearCurrentState();
        document.getElementById('restore-banner').classList.add('hidden');
        resetApp(false); // Reseta tudo, mas não as preferências salvas
    }

    function goToStep(stepNumber) {
        appData.currentStep = stepNumber;
        const steps = [1, 2, 3, 4, 5];
        steps.forEach(step => {
            const el = document.getElementById(`step-${step}`);
            if (el) el.classList.add('hidden');
        });
        const targetEl = document.getElementById(`step-${stepNumber}`);
        if (targetEl) targetEl.classList.remove('hidden');
        
        if (stepNumber >= 3) saveState();
        
        // Atualizar informações do Passo 3 ao mudar para ele
        if (stepNumber === 3) {
            document.getElementById('info-operador').textContent = appData.operador;
            document.getElementById('info-maquina').textContent = appData.maquina;
            document.getElementById('info-op-cp').textContent = `${appData.op} / ${appData.cp}`;
        }
    }

    function nextStep(currentStep) {
        if (currentStep === 1) {
            const operador = document.getElementById('operador').value.trim();
            const maquina = document.getElementById('maquina').value.trim();
            const saveOperador = document.getElementById('saveOperador').checked;
            const saveMaquina = document.getElementById('saveMaquina').checked;

            if (!operador || !maquina) {
                showMessage("Por favor, preencha o Nome do Operador e a Máquina.", true);
                return;
            }

            appData.operador = operador;
            appData.maquina = maquina;
            appData.prefSaveOperador = saveOperador;
            appData.prefSaveMaquina = saveMaquina;
            
            // Lógica de Salvar Preferências no localStorage
            if (saveOperador) {
                localStorage.setItem('savedOperador', operador);
            } else {
                localStorage.removeItem('savedOperador');
            }
            localStorage.setItem('prefSaveOperador', saveOperador ? 'true' : 'false');

            if (saveMaquina) {
                localStorage.setItem('savedMaquina', maquina);
            } else {
                localStorage.removeItem('savedMaquina');
            }
            localStorage.setItem('prefSaveMaquina', saveMaquina ? 'true' : 'false');
            
            goToStep(2);
        } else {
            goToStep(currentStep + 1);
        }
    }

    function prevStep(currentStep) {
        if (currentStep === 2) goToStep(1);
    }

    async function startProduction() {
        const op = document.getElementById('op').value.trim();
        const cp = document.getElementById('cp').value.trim();

        if (!op || !cp) {
            showMessage("Por favor, preencha a OP e o CP para iniciar.", true);
            return;
        }

        appData.op = op;
        appData.cp = cp;
        appData.startTime = new Date();
        appData.durationSeconds = 0;

        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);

        if (saveStateInterval) clearInterval(saveStateInterval);
        saveStateInterval = setInterval(saveState, 10000); // Salva a cada 10 segundos

        goToStep(3);
        await saveState(); // Salva imediatamente
        showMessage(`Produção (OP: ${op}) iniciada`, false);
    }

    function updateTimer() {
        if (appData.startTime) {
            const now = new Date();
            const elapsed = Math.floor((now - appData.startTime) / 1000);
            appData.durationSeconds = elapsed;
            TIMER_DISPLAY.textContent = formatDuration(elapsed);
        }
    }

    async function finishProduction() {
        if (timerInterval) clearInterval(timerInterval);
        if (saveStateInterval) clearInterval(saveStateInterval); 
        
        appData.endTime = new Date();

        if (appData.durationSeconds === 0) {
            showMessage("O tempo de produção precisa ser maior que 0 segundos.", true);
            // Poderia voltar para o Passo 2 ou recomeçar.
            return;
        }

        document.getElementById('summary-duration').textContent = formatDuration(appData.durationSeconds);
        document.getElementById('summary-operador').textContent = appData.operador;
        document.getElementById('summary-op-cp').textContent = `${appData.op} / ${appData.cp}`;
        document.getElementById('summary-start-end-time').textContent = `${formatDateTime(appData.startTime)} - ${formatDateTime(appData.endTime)}`;

        goToStep(4);
        await saveState(); // Salva o estado final
    }

    async function saveFinalData(saveButton) {
        const quantidade = document.getElementById('quantidade').value;
        const observacao = document.getElementById('observacao').value;
        const setupTime = document.getElementById('setupTime').value;

        if (quantidade === '' || isNaN(parseInt(quantidade))) {
            showMessage("Por favor, preencha a Quantidade Produzida.", true);
            return;
        }

        appData.quantity = parseInt(quantidade);
        appData.observation = observacao;
        appData.setupTime = parseInt(setupTime) || 0; // Se vazio, é 0

        if (SCRIPT_URL.includes('VOU_COLOCAR_AQUI_O_URL') || !SCRIPT_URL.startsWith('https://')) {
            showMessage("ERRO: Por favor, configure a URL do Google Apps Script (variável SCRIPT_URL) para o URL 'exec' do seu deployment.", true);
            return;
        }

        const dataToSend = {
            Operador: appData.operador,
            Maquina: appData.maquina,
            OP: appData.op,
            CP: appData.cp,
            HoraInicio: formatDateTime(appData.startTime),
            HoraFim: formatDateTime(appData.endTime),
            Duracao: formatDuration(appData.durationSeconds),
            Quantidade: appData.quantity,
            Observacao: appData.observation,
            SetupMinutos: appData.setupTime,
        };

        const btn = saveButton || document.querySelector('button[onclick*="saveFinalData"]');
        if (btn) { btn.disabled = true; btn.textContent = 'Enviando...'; }

        try {
            // Usa o fetch com 'no-cors' para envio simples de formulários via Apps Script
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                body: JSON.stringify(dataToSend)
            });

            // Como usamos 'no-cors', a resposta real não pode ser lida, mas assumimos sucesso se não houver erro de rede.

            showMessage("Dados enviados com sucesso! Verifique a planilha.", false);
            
            await clearCurrentState();
            
            goToStep(5);

        } catch (error) {
            console.error('Erro ao enviar dados:', error);
            showMessage("Erro ao salvar dados. Verifique a conexão ou a URL do Apps Script.", true);
            if (btn) { btn.disabled = false; btn.textContent = 'Salvar Dados Finais'; }
            return;
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'Salvar Dados Finais'; }
        }
    }

    // O parâmetro keepPrefs é opcional e false por default, mas é mais limpo carregar as preferências novamente
    async function resetApp() {
        // Limpar apenas os dados de sessão
        appData.startTime = null;
        appData.endTime = null;
        appData.durationSeconds = 0;
        appData.quantity = 0;
        appData.observation = '';
        appData.setupTime = '';
        if (!appData.prefSaveOperador) appData.operador = '';
        if (!appData.prefSaveMaquina) appData.maquina = '';
        appData.op = '';
        appData.cp = '';
        appData.currentStep = 1;

        // Limpar inputs da UI
        if (!appData.prefSaveOperador) document.getElementById('operador').value = '';
        if (!appData.prefSaveMaquina) document.getElementById('maquina').value = '';
        document.getElementById('op').value = '';
        document.getElementById('cp').value = '';
        document.getElementById('quantidade').value = '';
        document.getElementById('observacao').value = '';
        document.getElementById('setupTime').value = '';
        TIMER_DISPLAY.textContent = '00:00:00';

        if (timerInterval) clearInterval(timerInterval);
        if (saveStateInterval) clearInterval(saveStateInterval); 

        await clearCurrentState(); // Limpa o estado salvo no IndexedDB/localStorage
        
        // Recarrega as preferências para preencher campos se o "Lembrar" estiver ativo
        loadPreferences(); 
        
        goToStep(1);
    }
    
    // Função para carregar preferências e preencher campos
    function loadPreferences() {
        const operadorInput = document.getElementById('operador');
        const maquinaSelect = document.getElementById('maquina');
        const saveOperadorCheckbox = document.getElementById('saveOperador');
        const saveMaquinaCheckbox = document.getElementById('saveMaquina');

        // Preferência Operador
        const prefOperador = localStorage.getItem('prefSaveOperador');
        if (prefOperador === 'true') {
            const savedOperador = localStorage.getItem('savedOperador');
            if (savedOperador) {
                operadorInput.value = savedOperador;
                appData.operador = savedOperador;
            }
            saveOperadorCheckbox.checked = true;
            appData.prefSaveOperador = true;
        } else {
            saveOperadorCheckbox.checked = false;
            appData.prefSaveOperador = false;
        }

        // Preferência Máquina
        const prefMaquina = localStorage.getItem('prefSaveMaquina');
        if (prefMaquina === 'true') {
            const savedMaquina = localStorage.getItem('savedMaquina');
            if (savedMaquina) {
                maquinaSelect.value = savedMaquina;
                appData.maquina = savedMaquina;
            }
            saveMaquinaCheckbox.checked = true;
            appData.prefSaveMaquina = true;
        } else {
            saveMaquinaCheckbox.checked = false;
            appData.prefSaveMaquina = false;
        }
    }


    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Carrega as preferências de salvamento
        loadPreferences();
        
        // 2. Tenta restaurar a sessão
        const savedState = await getCurrentState();
        
        if (savedState && savedState.startTime && savedState.currentStep >= 3) {
            // Se houver estado válido, mostra o banner de restauração
            document.getElementById('restore-banner').classList.remove('hidden');
        } else {
            // Se não houver estado, inicia no passo 1
            goToStep(1);
        }
    });

    document.addEventListener('visibilitychange', () => {
        if (document.hidden && appData.startTime) {
            saveState();
            console.log('[v0] App went to background, state saved');
        }
    });

    window.addEventListener('beforeunload', () => {
        if (appData.startTime) {
            saveState();
        }
    });

    window.addEventListener('pagehide', () => {
        if (appData.startTime) {
            saveState();
        }
    });
</script>

<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log("Service Worker registrado!"))
    .catch(err => console.log("Erro ao registrar SW:", err));
}
</script>

</body>
</html>
